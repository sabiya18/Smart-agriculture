<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>My Profile - Smart Agri Rentals</title>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-storage.js"></script>

<style>
body { font-family:'Segoe UI', sans-serif; margin:0; background:linear-gradient(135deg,#d4fc79,#96e6a1); color:#333; }
header { background:#2e7d32; color:white; padding:1rem; text-align:center; font-size:1.5rem; font-weight:bold; position:sticky; top:0; box-shadow:0 3px 10px rgba(0,0,0,0.2);}
.profile-container { max-width:700px; margin:2rem auto; background:white; border-radius:12px; box-shadow:0 6px 20px rgba(0,0,0,0.15); padding:2rem; animation:fadeIn 0.7s ease-in-out; text-align:center; }
.profile-pic img { width:120px; height:120px; border-radius:50%; border:4px solid #4caf50; object-fit:cover; transition: transform 0.3s; }
.profile-pic img:hover { transform:scale(1.05); }
.profile-pic button { margin-top:0.5rem; background:linear-gradient(45deg,#4caf50,#2e7d32); border:none; color:white; padding:0.6rem 1.2rem; border-radius:25px; cursor:pointer; transition:all 0.3s; font-weight:bold; }
.profile-pic button:hover { background:linear-gradient(45deg,#66bb6a,#388e3c); transform:scale(1.05); }
form { margin-top:2rem; text-align:center; }
label { display:block; margin-top:1rem; font-weight:bold; color:#2e7d32; text-align:left; }
input, textarea { width:90%; padding:1rem; border:2px solid #4caf50; border-radius:10px; margin-top:0.5rem; font-size:1rem; transition:0.3s; background:#f8fff8; text-align:center; }
input:focus, textarea:focus { border-color:#2e7d32; box-shadow:0 0 10px rgba(46,125,50,0.3); outline:none; }
button.update-btn { margin-top:1.5rem; width:95%; background:linear-gradient(90deg,#4caf50,#2e7d32); border:none; padding:1rem; font-size:1.1rem; font-weight:bold; color:white; border-radius:10px; cursor:pointer; transition:all 0.3s; }
button.update-btn:hover { background:linear-gradient(90deg,#66bb6a,#388e3c); transform:scale(1.02); }
.past-bookings { margin-top:2rem; text-align:left; }
.past-bookings h3 { color:#2e7d32; }
.booking-card { background:#f9f9f9; border-radius:10px; padding:1rem; margin-top:1rem; box-shadow:0 3px 8px rgba(0,0,0,0.08); transition: transform 0.3s, box-shadow 0.3s; }
.booking-card:hover { transform:translateY(-3px); box-shadow:0 6px 15px rgba(0,0,0,0.15); }
@keyframes fadeIn { from {opacity:0; transform:translateY(15px);} to {opacity:1; transform:translateY(0);} }
@media (max-width:600px){ .profile-container{margin:1rem; padding:1rem;} input, textarea{width:100%;} }
</style>
</head>
<body>

<header>My Profile</header>

<div class="profile-container">
  <div class="profile-pic">
    <img id="profilePic" src="images/user.png" alt="Profile Picture" />
    <br />
    <input type="file" id="photoInput" accept="image/*" style="display:none" />
    <button onclick="photoInput.click()">Change Photo</button>
  </div>

  <form id="profileForm">
    <label>Full Name</label>
    <input type="text" id="fullName" required />
    <label>Email</label>
    <input type="email" id="email" required />
    <label>Phone</label>
    <input type="tel" id="phone" required />
    <label>Address</label>
    <textarea id="address" rows="3"></textarea>
    <button type="submit" class="update-btn">Update Profile</button>
  </form>

  <div class="past-bookings">
    <h3>Past Bookings</h3>
    <div id="bookingsList"></div>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js";
import { getFirestore, doc, getDoc, setDoc, collection, getDocs } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js";
import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-storage.js";

// Firebase Config
const firebaseConfig = {
  apiKey: "AIzaSyCOaZb_iRF_PGaxGWB0iRBnjIxzQvjHTP8",
  authDomain: "smartagroapp.firebaseapp.com",
  projectId: "smartagroapp-491dc",
  storageBucket: "smartagroapp.appspot.com",
  messagingSenderId: "1008595498005",
  appId: "1:1008595498005:web:2308f7f71feb0a8c45ca1c"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth();
const db = getFirestore(app);
const storage = getStorage(app);

const profilePic = document.getElementById("profilePic");
const photoInput = document.getElementById("photoInput");
const form = document.getElementById("profileForm");
const bookingsList = document.getElementById("bookingsList");

let userId = null;

onAuthStateChanged(auth, async (user) => {
  if (user) {
    userId = user.uid;
    await loadProfile();
  } else {
    alert("Please log in to access your profile.");
  }
});

async function loadProfile() {
  if (!userId) return;

  try {
    const userDocRef = doc(db, "users", userId);
    const userDocSnap = await getDoc(userDocRef);

    if (userDocSnap.exists()) {
      const data = userDocSnap.data();

      document.getElementById("fullName").value = data.fullName || "";
      document.getElementById("email").value = data.email || "";
      document.getElementById("phone").value = data.phone || "";
      document.getElementById("address").value = data.address || "";

      if (data.photoURL) {
        profilePic.src = data.photoURL + "?t=" + new Date().getTime();
      }
    }

    const bookingsRef = collection(db, "users", userId, "bookings");
    const bookingsSnap = await getDocs(bookingsRef);

    bookingsList.innerHTML = "";
    bookingsSnap.forEach((bookingDoc) => {
      const booking = bookingDoc.data();
      const div = document.createElement("div");
      div.className = "booking-card";
      div.innerText = `${booking.item || "Equipment"} - ${booking.start || ""} to ${booking.end || ""} - ₹${booking.amount || "N/A"}`;
      bookingsList.appendChild(div);
    });
  } catch (error) {
    console.error("Error loading profile:", error);
  }
}

form.addEventListener("submit", async (e) => {
  e.preventDefault();
  if (!userId) return alert("User not logged in");

  try {
    await setDoc(doc(db, "users", userId), {
      fullName: document.getElementById("fullName").value,
      email: document.getElementById("email").value,
      phone: document.getElementById("phone").value,
      address: document.getElementById("address").value
    }, { merge: true });
    alert("✅ Profile Updated Successfully!");
  } catch (error) {
    console.error("Error updating profile:", error);
    alert("Failed to update profile.");
  }
});

photoInput.addEventListener("change", async (e) => {
  if (!userId) return alert("User not logged in");
  const file = e.target.files[0];
  if (!file) return;

  const reader = new FileReader();
  reader.onload = (event) => profilePic.src = event.target.result;
  reader.readAsDataURL(file);

  try {
    const storageRef = ref(storage, `profilePhotos/${userId}`);
    await uploadBytes(storageRef, file);

    const url = await getDownloadURL(storageRef);
    await setDoc(doc(db, "users", userId), { photoURL: url }, { merge: true });

    console.log("✅ Profile photo uploaded successfully!");
  } catch (error) {
    console.error("Error uploading photo:", error);
    alert("Failed to upload photo.");
  }
});
</script>

</body>
</html>
